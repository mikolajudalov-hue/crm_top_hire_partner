{% extends 'layout.html' %}

{% block title %}–ú–æ–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—ã{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4">–ú–æ–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—ã</h1>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –≤—Å–µ–≥–æ</div>
          <div class="fs-3 fw-semibold">{{ partners_total }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">–ù–æ–≤—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
          <div class="fs-3 fw-semibold">{{ new_partners_month }}</div>
        </div>
      </div>
    </div>
  </div>

  {# –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞/–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ #}
  {% if recruiters %}
  <form class="row g-2 align-items-end mb-4" method="get">
    <div class="col-md-4">
      <label class="form-label">–†–µ–∫—Ä—É—Ç—ë—Ä</label>
      <select name="recruiter_id" class="form-select">
        <option value="">–í—Å–µ —Ä–µ–∫—Ä—É—Ç—ë—Ä—ã</option>
        {% for r in recruiters %}
          <option value="{{ r.id }}" {% if recruiter_filter_id == r.id %}selected{% endif %}>{{ r.name }} ({{ r.email }})</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</label>
      <select name="status" class="form-select">
        <option value="new" {% if status == 'new' %}selected{% endif %}>–ù–æ–≤—ã–µ</option>
        <option value="approved" {% if status == 'approved' %}selected{% endif %}>–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
        <option value="rejected" {% if status == 'rejected' %}selected{% endif %}>–û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ</option>
        <option value="all" {% if status == 'all' %}selected{% endif %}>–í—Å–µ</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </form>
  {% endif %}

  {# –ë–ª–æ–∫ –∑–∞—è–≤–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ #}
  <div class="mb-5">
    <h2 class="h4 mb-3">–ú–æ–∏ –∑–∞—è–≤–∫–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</h2>
    {% if not requests %}
      <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.</p>
    {% else %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>Email</th>
              <th>–ò–º—è</th>
              <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
              <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th style="width: 220px;">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            {% for r in requests %}
            <tr>
              <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '' }}</td>
              <td>{{ r.email }}</td>
              <td>{{ r.full_name }}</td>
              <td>{{ r.phone }}</td>
              <td>{{ r.note }}</td>
              <td>
                {% if r.status == 'new' %}
                  <span class="badge text-bg-warning">–ù–æ–≤–∞—è</span>
                {% elif r.status == 'approved' %}
                  <span class="badge text-bg-success">–û–¥–æ–±—Ä–µ–Ω–∞</span>
                {% elif r.status == 'rejected' %}
                  <span class="badge text-bg-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</span>
                {% else %}
                  {{ r.status }}
                {% endif %}
              </td>
              <td>
                {% if r.status == 'new' and g.user.role in ['recruiter','coordinator','director'] %}
                  <form method="post"
                        action="{{ url_for('admin.registration_approve', req_id=r.id) }}"
                        class="d-inline">
                    <button type="submit" class="btn btn-sm btn-success">
                      –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞
                    </button>
                  </form>
                  <form method="post"
                        action="{{ url_for('admin.registration_reject', req_id=r.id) }}"
                        class="d-inline"
                        onsubmit="return confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É {{ r.email }}?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                    </button>
                  </form>
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  {# –ë–ª–æ–∫ –¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ #}
  <div>
    <h2 class="h4 mb-3">–ú–æ–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—ã</h2>
    {% if not partners %}
      <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤.</p>
    {% else %}
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>–ò–º—è</th>
              <th>Email</th>
              <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              <th>–ó–¥–æ—Ä–æ–≤—å–µ</th>
              <th>–î–Ω–µ–π –±–µ–∑ –ø–æ–¥–∞—á</th>
              <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
            </tr>
          </thead>
          <tbody>
            {% for u in partners %}
            <tr>
              <td>{{ u.name }}</td>
              <td>{{ u.email }}</td>
              <td>{{ u.note }}</td>
              <td>
                {% if u.health_status == 'green' %}
                  üü¢ {{ u.health_status_label or '–ê–∫—Ç–∏–≤–Ω—ã–π' }}
                {% elif u.health_status == 'yellow' %}
                  üü° {{ u.health_status_label or '–ó–∞—Ç—É—Ö–∞–µ—Ç' }}
                {% elif u.health_status == 'red' %}
                  üî¥ {{ u.health_status_label or '–°–ø–∏—Ç' }}
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
                {% if u.health_score is not none %}
                  <span class="text-muted small ms-1">({{ u.health_score }})</span>
                {% endif %}
              </td>
              <td>
                {% if u.days_since_last is not none %}
                  {{ u.days_since_last }}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
              <td>
                {% if u.is_active %}
                  <span class="badge text-bg-success">–î–∞</span>
                {% else %}
                  <span class="badge text-bg-secondary">–ù–µ—Ç</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
